DIFFICULTY:-Medium
COMPANY:-Amazon

Question:-
In the domain of retail analytics, understanding customer behavior is crucial for driving business growth and enhancing customer satisfaction. One essential 
aspect is identifying customers who have purchased all available products, as they exhibit strong engagement with the product offerings and represent potential loyal customers.
Write an SQL to identify customers who have bought all the products available in products table along with total revenue generated by them. Sort the output by 
total revenue in decreasing order.

Table:customers
+---------------+-------------+
| COLUMN_NAME   | DATA_TYPE   |
+---------------+-------------+
| customer_id   | int         |
| customer_name | varchar(15) |
+---------------+-------------+

Table:products
+--------------+-------------+
| COLUMN_NAME  | DATA_TYPE   |
+--------------+-------------+
| product_id   | int         |
| product_name | varchar(10) |
| unit_price   | int         |
+--------------+-------------+

Table:orders
+-------------+-----------+
| COLUMN_NAME | DATA_TYPE |
+-------------+-----------+
| order_id    | int       |
| customer_id | int       |
| product_id  | int       |
| quantity    | int       |
| order_date  | date      |
+-------------+-----------+

My Solution:-
WITH totalProducts AS (
SELECT COUNT(*) AS totalProducts FROM products
  ),
  totalPurchased AS(
 select COUNT(DISTINCT product_id) AS totalProduct, customer_id
from orders
GROUP BY customer_id),
filterdCustomer AS(
SELECT * FROM totalPurchased WHERE totalProduct=(SELECT totalProducts FROM totalProducts)
  )
  SELECT customers.customer_name, SUM((products.unit_price * quantity)) AS totalCost
  FROM orders INNER JOIN products ON orders.product_id=products.product_id
  INNER JOIN customers ON customers.customer_id=orders.customer_id
  WHERE orders.customer_id IN (SELECT customer_id FROM filterdCustomer)
  GROUP BY customers.customer_name
  ORDER BY customers.customer_name

Actual Solution:-
select c.customer_name, sum(o.quantity*p.unit_price) as total_revenue
 from orders o
 inner join customers c on o.customer_id=c.customer_id
 inner join products p on o.product_id=p.product_id
 group by c.customer_name having count(distinct o.product_id)=(select count(*) from products)
 order by total_revenue desc;

DIFFICULTY:-Hard
COMPANY:-Linkein

Question:-
There are multiple antivirus software which are running on the system and you have the data of how many malware they have detected in each run.  
You need to find out how many malwares each software has detected in their latest run and what is the difference between the number of malwares detected in 
latest run and the second last run for each software. 

Please note that list only the software which have run for at least 2 times and have detected at least 10 malware in the latest run.

Table: malware
+------------------+-----------+
| COLUMN_NAME      | DATA_TYPE |
+------------------+-----------+
| software_id      | int       |
| run_date         | datetime  |
| malware_detected | int       |
+------------------+-----------+
My Question:-
WITH overallData AS(
SELECT software_id,
malware_detected AS latestRunCnt,
LEAD(malware_detected,1,0) OVER(PARTITION BY software_id ORDER BY run_Date DESC) AS secondLastRun,
ROW_NUMBER() OVER(PARTITION BY software_id ORDER BY run_Date DESC) AS rn,
COUNT(*) OVER(PARTITION BY software_id ) AS totalRun
FROM malware
)
SELECT software_id, latestRunCnt, (latestRunCnt-secondLastRun) AS differenceToPrevious
FROM overallData 
WHERE latestRunCnt>=10 AND rn=1 AND totalRun>=2

Actual Solution:-
with cte1 as (
select *,
row_number() over(partition by software_id order by run_date desc) as rn
 from malware 
)
,cte2 as (
select software_id
, sum(case when rn=1 then malware_detected end) as latest_run_count
, sum(case when rn=2 then malware_detected end) as previous_run
from cte1
where rn in (1,2)
group by software_id
having count(*)=2
)
select software_id,latest_run_count
,(latest_run_count-previous_run) as difference_to_previous 
from cte2
where latest_run_count>=10;
